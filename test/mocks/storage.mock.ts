import { vi } from 'vitest';
import type { IStorage } from '../../server/storage';
import type {
  HCPProfile,
  HCPFilter,
  SimulationResult,
  InsertSimulationScenario,
  DashboardMetrics,
  InsertAuditLog,
  AuditLog,
  StimuliEvent,
  CreateStimuliRequest,
  CounterfactualScenario,
  CreateCounterfactualRequest,
  NLQueryResponse,
  NLQueryRequest,
  ModelEvaluation,
  ModelHealthSummary,
  RecordOutcomeRequest,
  RunEvaluationRequest,
} from '@shared/schema';

// Sample mock data
export const mockHcpProfile: HCPProfile = {
  id: 'test-hcp-1',
  npi: '1234567890',
  firstName: 'John',
  lastName: 'Doe',
  specialty: 'Oncology',
  tier: 'Tier 1',
  segment: 'High Prescriber',
  organization: 'Test Hospital',
  city: 'New York',
  state: 'NY',
  overallEngagementScore: 75,
  channelPreference: 'email',
  channelEngagements: [
    { channel: 'email', score: 80, lastContact: '2 days ago', totalTouches: 15, responseRate: 45 },
    { channel: 'rep_visit', score: 65, lastContact: '1 week ago', totalTouches: 8, responseRate: 60 },
    { channel: 'webinar', score: 50, lastContact: null, totalTouches: 3, responseRate: 33 },
    { channel: 'conference', score: 40, lastContact: '1 month ago', totalTouches: 2, responseRate: 50 },
    { channel: 'digital_ad', score: 30, lastContact: '3 months ago', totalTouches: 20, responseRate: 15 },
    { channel: 'phone', score: 55, lastContact: '2 weeks ago', totalTouches: 5, responseRate: 40 },
  ],
  monthlyRxVolume: 45,
  yearlyRxVolume: 540,
  marketSharePct: 22.5,
  prescribingTrend: [
    { month: 'Jul', rxCount: 42, marketShare: 21 },
    { month: 'Aug', rxCount: 45, marketShare: 22 },
    { month: 'Sep', rxCount: 48, marketShare: 23 },
    { month: 'Oct', rxCount: 44, marketShare: 22 },
    { month: 'Nov', rxCount: 46, marketShare: 23 },
    { month: 'Dec', rxCount: 45, marketShare: 22.5 },
  ],
  conversionLikelihood: 68,
  churnRisk: 15,
  lastUpdated: new Date().toISOString(),
};

export const mockSimulationResult: SimulationResult = {
  id: 'sim-result-1',
  scenarioId: 'scenario-1',
  scenarioName: 'Test Campaign',
  predictedEngagementRate: 55.5,
  predictedResponseRate: 32.1,
  predictedRxLift: 12.3,
  predictedReach: 85,
  efficiencyScore: 72,
  channelPerformance: [
    { channel: 'email', allocation: 30, predictedResponse: 28.5, contribution: 25.2 },
    { channel: 'rep_visit', allocation: 40, predictedResponse: 45.2, contribution: 35.8 },
  ],
  vsBaseline: {
    engagementDelta: 8.5,
    responseDelta: 5.2,
    rxLiftDelta: 3.1,
  },
  runAt: new Date().toISOString(),
};

// Create a mock storage implementation
export function createMockStorage(): IStorage {
  return {
    getAllHcps: vi.fn().mockResolvedValue([mockHcpProfile]),
    getHcpById: vi.fn().mockResolvedValue(mockHcpProfile),
    getHcpByNpi: vi.fn().mockResolvedValue(mockHcpProfile),
    filterHcps: vi.fn().mockResolvedValue([mockHcpProfile]),
    findSimilarHcps: vi.fn().mockResolvedValue([mockHcpProfile]),
    createSimulation: vi.fn().mockResolvedValue(mockSimulationResult),
    getSimulationHistory: vi.fn().mockResolvedValue([mockSimulationResult]),
    getSimulationById: vi.fn().mockResolvedValue(mockSimulationResult),
    getDashboardMetrics: vi.fn().mockResolvedValue({
      totalHcps: 100,
      avgEngagementScore: 65,
      totalSimulations: 10,
      avgPredictedLift: 8.5,
      segmentDistribution: [],
      channelEffectiveness: [],
      tierBreakdown: [],
      engagementTrend: [],
    }),
    logAction: vi.fn().mockResolvedValue(undefined),
    getAuditLogs: vi.fn().mockResolvedValue([]),
    createStimuliEvent: vi.fn().mockResolvedValue({} as StimuliEvent),
    getStimuliEvents: vi.fn().mockResolvedValue([]),
    recordStimuliOutcome: vi.fn().mockResolvedValue({} as StimuliEvent),
    createCounterfactual: vi.fn().mockResolvedValue({} as CounterfactualScenario),
    getCounterfactualScenarios: vi.fn().mockResolvedValue([]),
    getCounterfactualById: vi.fn().mockResolvedValue({} as CounterfactualScenario),
    processNLQuery: vi.fn().mockResolvedValue({} as NLQueryResponse),
    getNLQueryHistory: vi.fn().mockResolvedValue([]),
    recordOutcome: vi.fn().mockResolvedValue({} as StimuliEvent),
    runModelEvaluation: vi.fn().mockResolvedValue({} as ModelEvaluation),
    getModelEvaluations: vi.fn().mockResolvedValue([]),
    getModelHealthSummary: vi.fn().mockResolvedValue({} as ModelHealthSummary),
    seedHcpData: vi.fn().mockResolvedValue(undefined),
    getHcpCount: vi.fn().mockResolvedValue(100),
  };
}
